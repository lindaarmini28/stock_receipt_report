<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============================================================ -->
    <!-- Stock Picking Form: Reference Fields for Receipt & Internal -->
    <!-- ============================================================ -->
    <record id="stock_picking_form_reference_fields" model="ir.ui.view">
        <field name="name">stock.picking.form.inherit.reference.fields</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form"/>
        <field name="priority">50</field>
        <field name="arch" type="xml">

            <!-- ============================================= -->
            <!-- INVISIBLE FIELDS FOR ATTRS -->
            <!-- picking_type_sequence_code must be in view for attrs to work -->
            <!-- ============================================= -->
            <xpath expr="//field[@name='picking_type_id']" position="after">
                <field name="picking_type_sequence_code" invisible="1"/>
                <field name="receipt_sign_state" invisible="1"/>
            </xpath>

            <!-- ============================================= -->
            <!-- VENDOR SIGNATURE BUTTON (for validated Receipts) -->
            <!-- ============================================= -->
            <xpath expr="//button[@name='button_validate']" position="after">
                <!-- Request Vendor Signature - only when validated but not yet requested -->
                <button name="action_request_vendor_signature"
                        type="object"
                        string="Request Vendor Signature"
                        class="btn-secondary"
                        attrs="{'invisible': ['|', '|', ('state', '!=', 'done'), ('picking_type_sequence_code', '!=', 'IN'), ('receipt_sign_state', 'in', ['requested', 'signed'])]}"
                        icon="fa-pencil"/>
                <!-- View Signature Link - when already requested but not yet signed -->
                <button name="action_view_vendor_sign_url"
                        type="object"
                        string="View Signature Link"
                        class="btn-secondary"
                        attrs="{'invisible': ['|', '|', ('state', '!=', 'done'), ('picking_type_sequence_code', '!=', 'IN'), ('receipt_sign_state', '!=', 'requested')]}"
                        icon="fa-link"/>
            </xpath>
            
            <!-- ============================================= -->
            <!-- SIGNATURE STATUS BANNER (for validated Receipts only) -->
            <!-- Subtle header banner showing signature workflow progress -->
            <!-- ============================================= -->
            <xpath expr="//sheet" position="before">
                <!-- Vendor Signed - Green success banner -->
                <div class="alert alert-success py-2 mb-0" role="status"
                     attrs="{'invisible': ['|', '|', ('picking_type_sequence_code', '!=', 'IN'), ('state', '!=', 'done'), ('receipt_sign_state', '!=', 'signed')]}">
                    <i class="fa fa-check-circle"/> <strong>Vendor Signature Completed</strong>
                </div>
                <!-- Signature Requested - Yellow warning banner -->
                <div class="alert alert-warning py-2 mb-0" role="status"
                     attrs="{'invisible': ['|', '|', ('picking_type_sequence_code', '!=', 'IN'), ('state', '!=', 'done'), ('receipt_sign_state', '!=', 'requested')]}">
                    <i class="fa fa-clock-o"/> <strong>Waiting for Vendor Signature</strong>
                </div>
                <!-- Validated but not yet requested - Info banner -->
                <div class="alert alert-info py-2 mb-0" role="status"
                     attrs="{'invisible': ['|', '|', ('picking_type_sequence_code', '!=', 'IN'), ('state', '!=', 'done'), ('receipt_sign_state', '!=', 'validated')]}">
                    <i class="fa fa-info-circle"/> Ready to request vendor signature
                </div>
            </xpath>

            <!-- ============================================= -->
            <!-- OPERATIONS TAB: Reference Fields -->
            <!-- Only visible for IN (Receipt) and INT (Internal Transfer) -->
            <!-- ============================================= -->

            <!-- Reference Fields - AFTER product_id -->
            <xpath expr="//field[@name='move_ids_without_package']/tree/field[@name='product_id']"
                   position="after">
                
                <!-- Product Image from PO/SO -->
                <field name="ref_product_image"
                       string="Image"
                       widget="image"
                       options="{'size': [128, 128]}"
                       attrs="{'column_invisible': [('parent.picking_type_sequence_code', 'not in', ['IN', 'INT'])]}"/>

                <!-- Product Dimensions from PO/SO -->
                <field name="ref_product_length"
                       string="Length (cm)"
                       attrs="{'column_invisible': [('parent.picking_type_sequence_code', 'not in', ['IN', 'INT'])]}"/>
                <field name="ref_product_width"
                       string="Width (cm)"
                       attrs="{'column_invisible': [('parent.picking_type_sequence_code', 'not in', ['IN', 'INT'])]}"/>
                <field name="ref_product_height"
                       string="Height (cm)"
                       attrs="{'column_invisible': [('parent.picking_type_sequence_code', 'not in', ['IN', 'INT'])]}"/>

                <!-- Qty from source order -->
                <field name="ref_qty_ordered"
                       string="Qty Order"
                       attrs="{'column_invisible': [('parent.picking_type_sequence_code', 'not in', ['IN', 'INT'])]}"/>

                <!-- Source indicator (optional, for debugging) -->
                <!-- 
                <field name="ref_source_type"
                       string="Source"
                       attrs="{'column_invisible': [('parent.picking_type_sequence_code', 'not in', ['IN', 'INT'])]}"/>
                -->
            </xpath>

        </field>
    </record>

</odoo>